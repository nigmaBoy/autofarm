-- // AUTO-EXECUTE RELOADER \\ --
local script_to_run = [[loadstring(game:HttpGet("https://raw.githubusercontent.com/nigmaBoy/autofarm/refs/heads/main/main"))()]]
if syn and syn.queue_on_teleport then
    syn.queue_on_teleport(script_to_run)
elseif queue_on_teleport then
    queue_on_teleport(script_to_run)
end

if getgenv().OPTIMIZED_FARM_LOADED then return end
getgenv().OPTIMIZED_FARM_LOADED = true

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({Name = "OPTIMIZED FARM", LoadingTitle = "Loading...", ConfigurationSaving = {Enabled = false}})
local Tab = Window:CreateTab("Main", 4483362458)

local LP = game.Players.LocalPlayer
local RS = game:GetService("RunService")
local WS = workspace
local RE = game:GetService("ReplicatedStorage"):WaitForChild("MainEvent")
local TS = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local GuiService = game:GetService("GuiService")

-- // FILENAMES \\ --
local STATS_FILENAME = "OptimizedFarm_Stats.txt"
local HISTORY_FILENAME = "OptimizedFarm_History.txt"

-- // VARIABLES \\ --
local SafeCFrame = CFrame.new(-657.105, -45.438, -285.495)
local IdlePosition = SafeCFrame * CFrame.new(0, 20, 0)
local LockingPosition = IdlePosition
local IsLocking = true
local KOCount = 0 

-- Persistent Stats
local totalMoneyGained = 0 
local totalTimeFarmed = 0  
local currentSessionMoney = 0 
local currentSessionTime = 0  
local lastExecutionTimestamp = 0

-- Live tracking
local serverStartMoney = 0
local serverStartTime = tick()

-- // UI LABELS \\ --
local SessionGainedLabel = Tab:CreateLabel("Session Gained: $0")
local MoneyPerMinLabel = Tab:CreateLabel("Session Money/Min: $0")
local MoneyPerHourLabel = Tab:CreateLabel("Session Money/Hour: $0")
Tab:CreateDivider()
local TotalGainedLabel = Tab:CreateLabel("Total Gained (All Time): $0")
local AvgMoneyPerHourLabel = Tab:CreateLabel("Average Money/Hour: $0")

-- // STATS SYSTEM \\ --
local function SaveStats()
    pcall(function()
        local data = {
            totalMoney = totalMoneyGained,
            totalTime = totalTimeFarmed,
            sessionMoney = currentSessionMoney,
            sessionTime = currentSessionTime,
            lastExec = tick()
        }
        writefile(STATS_FILENAME, HttpService:JSONEncode(data))
    end)
end

local function LoadStats()
    pcall(function()
        if isfile(STATS_FILENAME) then
            local data = HttpService:JSONDecode(readfile(STATS_FILENAME))
            totalMoneyGained = data.totalMoney or 0
            totalTimeFarmed = data.totalTime or 0
            if (tick() - (data.lastExec or 0)) > 3600 then
                currentSessionMoney = 0
                currentSessionTime = 0
            else
                currentSessionMoney = data.sessionMoney or 0
                currentSessionTime = data.sessionTime or 0
            end
            lastExecutionTimestamp = data.lastExec or tick()
        end
    end)
end

-- // SERVER HISTORY & HOPPING \\ --
local function GetServerHistory()
    local history = {}
    pcall(function()
        if isfile(HISTORY_FILENAME) then
            local data = HttpService:JSONDecode(readfile(HISTORY_FILENAME))
            for id, timestamp in pairs(data) do
                if (tick() - timestamp) < 600 then history[id] = timestamp end
            end
        end
    end)
    return history
end

local function AddToHistory(jobId)
    local history = GetServerHistory()
    history[jobId] = tick()
    writefile(HISTORY_FILENAME, HttpService:JSONEncode(history))
end

local function ServerHop()
    local serverElapsed = tick() - serverStartTime
    local currencyVal = (LP:FindFirstChild("DataFolder") and LP.DataFolder:FindFirstChild("Currency")) and LP.DataFolder.Currency.Value or serverStartMoney
    local serverGained = currencyVal - serverStartMoney
    
    if serverGained > 0 then
        totalMoneyGained = totalMoneyGained + serverGained
        totalTimeFarmed = totalTimeFarmed + serverElapsed
        currentSessionMoney = currentSessionMoney + serverGained
        currentSessionTime = currentSessionTime + serverElapsed
    end
    SaveStats()
    AddToHistory(game.JobId)

    local function TryTeleport()
        local url = "https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Desc&limit=100"
        local success, result = pcall(function() return game:HttpGet(url) end)
        if not success then return end
        local data = HttpService:JSONDecode(result)
        local history = GetServerHistory()
        local validServers = {}
        for _, server in pairs(data.data) do
            if server.playing < server.maxPlayers and server.id ~= game.JobId and not history[server.id] then
                table.insert(validServers, server.id)
            end
        end
        if #validServers > 0 then
            TS:TeleportToPlaceInstance(game.PlaceId, validServers[math.random(1, #validServers)], LP)
        else
            TS:Teleport(game.PlaceId, LP)
        end
    end

    local errorConn; errorConn = GuiService.ErrorMessageChanged:Connect(function()
        task.wait(1)
        errorConn:Disconnect()
        ServerHop()
    end)

    TryTeleport()
    task.delay(15, function() if errorConn then errorConn:Disconnect() end TryTeleport() end)
end

-- // ANTI-KO & ANTI-GRAB MONITORING \\ --
local function CharacterMonitor(Char)
    if not Char then return end
    local BodyEffects = Char:WaitForChild("BodyEffects", 10)
    if BodyEffects then
        local KO = BodyEffects:WaitForChild("K.O", 5)
        local Grabbed = BodyEffects:WaitForChild("Grabbed", 5)

        if KO then
            KO:GetPropertyChangedSignal("Value"):Connect(function()
                if KO.Value == true then
                    KOCount = KOCount + 1
                    if KOCount >= 2 then ServerHop() end
                end
            end)
        end

        if Grabbed then
            Grabbed:GetPropertyChangedSignal("Value"):Connect(function()
                if Grabbed.Value == true then ServerHop() end
            end)
        end
    end
end

LP.CharacterAdded:Connect(CharacterMonitor)
if LP.Character then task.spawn(CharacterMonitor, LP.Character) end

-- // 1. INSTANT GRENADE WELD (IMPROVED ACCURACY) \\ --
WS.Ignored.ChildAdded:Connect(function(v)
    if v.Name == "Handle" or v.Name == "Grenade" then
        task.spawn(function()
            local door = WS.MAP.Map.Vault:FindFirstChild("VaultDoor")
            while v and v.Parent and door and door.Parent do
                v.CanCollide = false
                v.Velocity = Vector3.zero
                v.AssemblyLinearVelocity = Vector3.zero
                v.AssemblyAngularVelocity = Vector3.zero
                v.CFrame = door.CFrame
                RS.Heartbeat:Wait()
            end
        end)
    end
end)

-- // 2. PLAYER LOCKING \\ --
RS.RenderStepped:Connect(function()
    if IsLocking and LockingPosition and LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then
        LP.Character.HumanoidRootPart.CFrame = LockingPosition
        LP.Character.HumanoidRootPart.Velocity = Vector3.zero
    end
end)

-- // 3. GLOBAL AUTO PICKUP \\ --
task.spawn(function()
    while true do
        pcall(function()
            local Char = LP.Character
            if Char and Char:FindFirstChild("HumanoidRootPart") then
                for _, v in pairs(WS.Ignored.Drop:GetChildren()) do
                    if v.Name == "MoneyDrop" and v:FindFirstChild("ClickDetector") then
                        if (v.Position - Char.HumanoidRootPart.Position).Magnitude < 25 then 
                            fireclickdetector(v.ClickDetector)
                        end
                    end
                end
            end
        end)
        task.wait(0.2)
    end
end)

-- // 4. FUNCTIONS \\ --
local function GetTotalAmmo()
    local ammoFrame = LP.PlayerGui.MainScreenGui:FindFirstChild("AmmoFrame")
    if ammoFrame and ammoFrame:FindFirstChild("AmmoText") then
        local rawText = ammoFrame.AmmoText.Text
        return tonumber(string.match(rawText, "%d+")) or 0
    end
    return 0
end

local function Buy(name, duration)
    local Char = LP.Character
    if not Char or not Char:FindFirstChild("HumanoidRootPart") then return end
    Char.Humanoid:UnequipTools()
    local wasLocking = IsLocking
    IsLocking = false
    task.wait(0.1) 
    local s = WS.Ignored.Shop:FindFirstChild(name)
    if not s then if wasLocking then IsLocking = true end return end
    local p = s:FindFirstChild("Head") or s:FindFirstChild("Handle")
    local c = s:FindFirstChild("ClickDetector") or p:FindFirstChild("ClickDetector")
    if p and c then
        local old = Char.HumanoidRootPart.CFrame
        local t = tick()
        repeat
            LP.Character.HumanoidRootPart.CFrame = p.CFrame
            fireclickdetector(c)
            RS.Heartbeat:Wait()
        until tick() - t > (duration or 0.5)
        Char.HumanoidRootPart.CFrame = old
    end
    if wasLocking then IsLocking = true end
end

local function FireBurst(vault, Gun)
    local Handle = Gun:FindFirstChild("Handle")
    local TargetPart = vault:FindFirstChild("Head") or vault:FindFirstChild("Part")
    if not TargetPart or not Handle then return end
    local gunRemote = Gun:FindFirstChild("RemoteEvent")
    if gunRemote then gunRemote:FireServer("Shoot") end
    local MuzzlePos = (Handle.CFrame * CFrame.new(-0.1, 0.5, -2.5)).Position 
    local TimeNow = workspace:GetServerTimeNow() 
    for i = 1, 5 do
        local v17 = math.random() > 0.5 and math.random() * 0.05 or -math.random() * 0.05
        local v18 = math.random() > 0.5 and math.random() * 0.1 or -math.random() * 0.1
        local v19 = math.random() > 0.5 and math.random() * 0.05 or -math.random() * 0.05
        local EndPos = TargetPart.Position + Vector3.new(v17, v18, v19)
        RE:FireServer("ShootGun", Handle, MuzzlePos, EndPos, TargetPart, Vector3.new(0, 1, 0), TimeNow)
    end
end

local function ThrowGrenadePair()
    local Char = LP.Character
    if not Char then return end
    for _, item in ipairs(LP.Backpack:GetChildren()) do
        if item.Name == "[Grenade]" then item:Destroy() end
    end
    Buy("[Grenade] - $788", 0.8)
    task.wait(0.2)
    for i = 1, 2 do
        local grenade = LP.Backpack:FindFirstChild("[Grenade]")
        if grenade then
            Char.Humanoid:EquipTool(grenade)
            task.wait(0.4)
            if grenade.Parent == Char then
                 grenade:Activate(); task.wait(0
